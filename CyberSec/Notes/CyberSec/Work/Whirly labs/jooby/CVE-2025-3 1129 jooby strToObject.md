https://www.cve.org/CVERecord?id=CVE-2025-31129
https://cwe.mitre.org/data/definitions/502.html
https://github.com/jooby-project/jooby/security/advisories/GHSA-7c5v-895v-w4q5

March 31

Jooby: web framework for java

### Patches
- 2.17.0 (2.x)
- 3.7.0 (3.x)

affected:
active: 
https://github.com/jooby-project/jooby/tree/v3.6.1
https://github.com/jooby-project/jooby/tree/v3.7.0


not active
https://github.com/jooby-project/jooby/tree/v2.16.4
https://github.com/jooby-project/jooby/tree/v2.17.0

Vuln
File: SessionStoreImpl.java
- Handle sessions and getting key values
- In strToObject
- deserializes a value if the value starts with b64


file
https://github.com/jooby-project/jooby/blob/v3.6.1/modules/jooby-pac4j/src/main/java/io/jooby/internal/pac4j/SessionStoreImpl.java#L77-L84

`Context` is our http request/response along with session data

`map(SessionStoreImpl::strToObject)`

strToObject line 123
`static Optional<Object> strToObject(final Value node)`

Return a `Optional<Object>`
- Return a value that may or may not be null of type Object
- instead of null you'd return Optional.empty()
	- `.isPresent()`, `.ifPresent()`, `.orElse()` also possible, better to read and safer

Pass in a `final Value node`
Value interface:
- Unify access to http values 
- Types of values
	- Single Value: Can be converted to primitive or primitive like values
	- Object Value: key:value structure, 
	- Seq of values (arrays): Index based sequence of values 
- All types modelled into a single value class
-  At any time you can treat a value as
	 * 1) single, 2) hash or 3) array of them.

for strToObject it's assumed value is a string primitive 

Once passed in
case1 : starts with "b64~"
- decode to bytes 
- feed bytes into `ByteArrayInputStream`
- feed this into `ObjectInputStream`
	- https://docs.oracle.com/javase/8/docs/api/java/io/ObjectInputStream.html
	- deserializes primitive data and objects previously written using an ObjectOutputStream. 
	- `readObject` is needed for `ByteArrayInputStream` to trigger deserialization
		- Java will creata a default one but a threat actor can overload this for malicious code
		- The threat actor can also use a static initialise to get code execution 
- return the object of this type

case2 : starts with "p4j~"
- reads string and returns an http code 

case3: return value passed in?


How to exploit
Server prerequisites:
- Accepts a query string from a GET request that get's stored as a session
- Fetches this session value sometime later using 

Use ObjectOutputStream to create a malicious byte string then base64 encode it.
- Implement a malicious "readObject"
- Use a static initializer
Pass this into the query string with a value used as a session that get's called 
![[Pasted image 20250615154644.png]]
When the session data is fetched the malicious code runs

example
https://github.com/cwm1123/CVE-2025-31129/blob/master/src/main/java/org/example/Main.java


commit to fix
https://github.com/jooby-project/jooby/commit/3e13562cf36d7407813eae464e0f4b598de15692
Present in current code base 

Switched from map - flatMap

signature of strToObject changed
`static Optional<Object> strToObject(Serializer serializer, Value node)` 
now use the Serializer class from pac4j
`import org.pac4j.core.util.serializer.Serializer;`

Moved deserialization responsibility to pac4j 
`return Optional.of(serializer.deserializeFromString(value.substring(BIN.length())));`
Use pac4j's serializer instead of `ObjectInputStream`

https://javadoc.io/doc/org.pac4j/pac4j-core/latest/org/pac4j/core/util/serializer/package-summary.html
https://github.com/pac4j/pac4j/blob/master/pac4j-core/src/main/java/org/pac4j/core/util/serializer/JavaSerializer.java

`deserializeFromString`
https://github.com/pac4j/pac4j/blob/master/pac4j-core/src/main/java/org/pac4j/core/util/serializer/AbstractSerializer.java
`deserializeFromString(final String encoded)` 
-> `internalDeserializeFromString(encoded)`
	-> `Base64.getDecoder().decode(encoded);` then call
-> `internalDeserializeFromBytes(enc);`
Which is implemented in Java serializer
https://github.com/pac4j/pac4j/blob/master/pac4j-core/src/main/java/org/pac4j/core/util/serializer/JavaSerializer.java
Line 62
We use a 
'RestrictedObjectInputStream'
Deserialization is done only if the class is in a trusted list
- this.trustedPackages
- this.trustedClasses


Trying to mimick a trusted package/class by changing the contents of an existing class does not appear to work, the attacker would need to somehow smuggle in a malicious class in the code base to exploit this attack vector.
It can be reasonable assumed to be fixed 


# Joern
Make sure 
`new ObjectInputStream(new ByteArrayInputStream(bytes)).readObject()`
is absent from strToObject





